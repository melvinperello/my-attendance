<!DOCTYPE html>
<html lang="en">
  <%- include('./partials/head.ejs',{title:"our-attendance - Login"}) -%>
  <body>
    <%- include('./partials/nav.ejs') -%>
    <main>
      <div class="container mt-3">
        <div class="row justify-content-center">
          <div class="col col-sm-4">
            <div class="card">
              <div class="card-body">
                <!--  -->
                <form id="frm_login">
                  <div class="mb-3">
                    <label for="txt_username" class="form-label"
                      >username</label
                    >
                    <input
                      readonly
                      value="<%= username %>"
                      type="text"
                      class="form-control"
                      name="txt_username"
                      id="txt_username"
                      placeholder="username"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="txt_code" class="form-label">code</label>
                    <input
                      type="text"
                      class="form-control"
                      id="txt_code"
                      name="txt_code"
                      aria-describedby="lbl_code"
                      autocomplete="off"
                      placeholder="code"
                      required
                    />
                    <div id="lbl_code" class="form-text">
                      open your authenticator app to get the code.
                    </div>
                  </div>
                  <div class="d-grid gap-2">
                    <button
                      id="btn_submit"
                      type="submit"
                      class="btn btn-primary"
                    >
                      login
                    </button>
                  </div>
                </form>
                <!--  -->
              </div>
            </div>
            <!--  -->
            <div
              id="msg_not_exists"
              class="alert alert-danger d-flex align-items-center mt-2"
              role="alert"
            >
              <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
              <div>Wrong code.</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      $(function () {
        $("#msg_not_exists").css("visibility", "hidden");
        $("#frm_login").submit(function (event) {
          event.preventDefault();
          $("#btn_submit").prop("disabled", true);
          const data = $("#frm_login")
            .serializeArray()
            .reduce(function (obj, item) {
              obj[item.name] = item.value;
              return obj;
            }, {});
          // AJAX HERE
          $.ajax({
            url: "/api/login",
            type: "POST",
            data: JSON.stringify({
              code: data.txt_code,
              username: data.txt_username,
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
          })
            .done(function (res) {
              const date = new Date();
              const minutes = 15;
              date.setTime(date.getTime() + minutes * 60 * 1000);
              $.cookie("token", res.data.token, { expires: date, path: "/" });
              window.location.href = "/main?token=" + res.data.token;
            })
            .fail(function (xhr) {
              $("#msg_not_exists").css("visibility", "visible");
              $("#btn_submit").prop("disabled", false);
            });
        });
      });
    </script>
  </body>
</html>
